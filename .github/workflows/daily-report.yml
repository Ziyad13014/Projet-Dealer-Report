name: ðŸ“Š Daily SpiderVision Report

on:
  # ExÃ©cution quotidienne Ã  07:30 UTC (09:30 heure de Paris en Ã©tÃ©)
  schedule:
    - cron: "30 7 * * *"
  
  # Permet l'exÃ©cution manuelle depuis GitHub
  workflow_dispatch:

jobs:
  generate-report:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ Setup Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: 'pip'

      - name: ðŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: ðŸ“Š Generate SpiderVision Report
        env:
          SPIDER_VISION_API_BASE: ${{ secrets.SPIDER_VISION_API_BASE }}
          SPIDER_VISION_EMAIL: ${{ secrets.SPIDER_VISION_EMAIL }}
          SPIDER_VISION_PASSWORD: ${{ secrets.SPIDER_VISION_PASSWORD }}
          SPIDER_VISION_JWT_TOKEN: ${{ secrets.SPIDER_VISION_JWT_TOKEN }}
          SPIDER_VISION_LOGIN_ENDPOINT: ${{ secrets.SPIDER_VISION_LOGIN_ENDPOINT }}
          SPIDER_VISION_OVERVIEW_ENDPOINT: ${{ secrets.SPIDER_VISION_OVERVIEW_ENDPOINT }}
        run: |
          echo "ðŸ”„ GÃ©nÃ©ration du rapport en cours..."
          python generate_new_report.py
          echo "âœ… Rapport gÃ©nÃ©rÃ© avec succÃ¨s !"

      - name: ðŸ“¤ Upload report as artifact
        uses: actions/upload-artifact@v4
        with:
          name: spidervision-report-${{ github.run_number }}
          path: |
            reports/last_day_history_live_report_*.html
            reports/spider_vision_overview_current.csv
            index.html
          retention-days: 30

      - name: ðŸ“ Create summary
        run: |
          echo "## ðŸ“Š Rapport SpiderVision gÃ©nÃ©rÃ©" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Le rapport a Ã©tÃ© gÃ©nÃ©rÃ© avec succÃ¨s !" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“… Date: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¥ TÃ©lÃ©chargez le rapport depuis l'onglet 'Artifacts' ci-dessus." >> $GITHUB_STEP_SUMMARY
          
          # Lister les fichiers gÃ©nÃ©rÃ©s
          if [ -d "reports" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Fichiers gÃ©nÃ©rÃ©s:" >> $GITHUB_STEP_SUMMARY
            ls -lh reports/*.html | tail -5 | awk '{print "- " $9 " (" $5 ")"}' >> $GITHUB_STEP_SUMMARY
          fi
